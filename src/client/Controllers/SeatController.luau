--!strict
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Packages = ReplicatedStorage:WaitForChild("Packages")
local Knit = require(Packages:WaitForChild("Knit"))

-- Variable privada (Solo este script la conoce)
local _player = Players.LocalPlayer

local SeatController = Knit.CreateController({
	Name = "SeatController",
})

function SeatController:KnitStart()
	print("ğŸš€ [SeatController] KnitStart: Iniciando...")

	-- CASO 1: El personaje ya existe al cargar el script
	if _player.Character then
		print("ğŸ“¦ [SeatController] Personaje detectado al inicio. Procesando...")
		task.spawn(function()
			self:_onCharacterAdded(_player.Character :: Model)
		end)
	end

	-- CASO 2: El personaje carga despuÃ©s o revive (Respawn)git
	_player.CharacterAdded:Connect(function(character)
		print("â™»ï¸ [SeatController] CharacterAdded disparado (Nuevo personaje).")
		self:_onCharacterAdded(character)
	end)
end

function SeatController:_onCharacterAdded(character: Model)
	print("ğŸ” [SeatController] Buscando Humanoid en: " .. character.Name)

	local humanoid = character:WaitForChild("Humanoid", 5) :: Humanoid?

	if not humanoid then
		print("âŒ [SeatController] Error: No se encontrÃ³ Humanoid a tiempo.")
		return
	end

	print("âœ… [SeatController] Humanoid encontrado. Conectando evento .Seated")

	-- Escuchar cuando el estado de sentado cambia
	humanoid.Seated:Connect(function(isSeated: boolean, seatPart: Instance?)
		if isSeated then
			local name = if seatPart then seatPart.Name else "Asiento Desconocido"
			print("ğŸª‘ [SeatController] EVENTO: El jugador se ha SENTADO en: " .. name)
		else
			print("ğŸƒ [SeatController] EVENTO: El jugador se ha LEVANTADO.")
		end
	end)
end

return SeatController
